name: Build and attach release artifacts

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-and-upload:
    name: Build examples and upload artifacts
    strategy:
      matrix:
        # platform combines OS and arch. We'll map to runs-on below.
        platform: [linux-x86_64, linux-aarch64, macos-aarch64]
    runs-on: ${{ contains(matrix.platform, 'macos') && 'macos-latest' || 'ubuntu-latest' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Fetch dependencies
        run: cargo fetch

      - name: Prepare and build for platform
        shell: bash
        run: |
          set -euo pipefail
          PLATFORM=${{ matrix.platform }}
          REFNAME=${GITHUB_REF##*/}
          if [ -z "$REFNAME" ]; then
            REFNAME=${GITHUB_SHA:0:7}
          fi
          mkdir -p artifacts

          case "$PLATFORM" in
            linux-x86_64)
              ZIP_NAME="melsec_com-${REFNAME}-linux-x86_64.zip"
              echo "Building native linux x86_64"
              cargo build --release --examples
              EXAMPLES_DIR="target/release/examples"
              ;;
            linux-aarch64)
              ZIP_NAME="melsec_com-${REFNAME}-linux-aarch64.zip"
              echo "Building linux aarch64 using cross (Docker-backed)"
              # Install cross (uses Docker under the hood). Requires Docker on runner.
              cargo install cross --locked || true
              # Ensure the aarch64 target exists for fallbacks
              rustup target add aarch64-unknown-linux-gnu || true
              # Try to build using cross for more reliable cross-compilation
              if command -v cross >/dev/null 2>&1; then
                cross build --release --examples --target aarch64-unknown-linux-gnu || true
                EXAMPLES_DIR="target/aarch64-unknown-linux-gnu/release/examples"
              else
                # Fallback to local cross compile if cross is not available
                echo "cross not available; attempting local cross build"
                if command -v sudo >/dev/null 2>&1; then
                  sudo apt-get update -y && sudo apt-get install -y gcc-aarch64-linux-gnu || true
                fi
                cargo build --release --examples --target aarch64-unknown-linux-gnu || true
                EXAMPLES_DIR="target/aarch64-unknown-linux-gnu/release/examples"
              fi
              ;;
            macos-x86_64)
              ZIP_NAME="melsec_com-${REFNAME}-macos-x86_64.zip"
              echo "Building macOS (native)"
              cargo build --release --examples
              EXAMPLES_DIR="target/release/examples"
              ;;
            macos-aarch64)
              ZIP_NAME="melsec_com-${REFNAME}-macos-aarch64.zip"
              echo "Building macOS arm64 (native if runner is arm)"
              # On macOS runners, building for arm64 is typically native on Apple Silicon runners.
              # Try building target if requested; fallback to native build.
              rustup target add aarch64-apple-darwin || true
              cargo build --release --examples || true
              EXAMPLES_DIR="target/release/examples"
              ;;
            *)
              echo "Unknown platform: $PLATFORM" >&2
              exit 1
              ;;
          esac

          # Package artifacts: exclude debug symbols (.pdb) and dependency files (.d)
          if [ -d "$EXAMPLES_DIR" ]; then
            echo "Packaging examples from $EXAMPLES_DIR"
            ls -la "$EXAMPLES_DIR" || true
            cd "$EXAMPLES_DIR"
            zip -r "$GITHUB_WORKSPACE/artifacts/${ZIP_NAME}" . -x "*.pdb" "*.d"
          else
            echo "ERROR: EXAMPLES_DIR $EXAMPLES_DIR does not exist" >&2
            echo "Current dir: $(pwd)" >&2
            ls -la || true
            exit 1
          fi
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV

          # Generate checksum for the zip
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "$GITHUB_WORKSPACE/artifacts/${ZIP_NAME}" > "$GITHUB_WORKSPACE/artifacts/${ZIP_NAME}.sha256"
          else
            shasum -a 256 "$GITHUB_WORKSPACE/artifacts/${ZIP_NAME}" > "$GITHUB_WORKSPACE/artifacts/${ZIP_NAME}.sha256"
          fi
          echo "ZIP_CHECKSUM=${ZIP_NAME}.sha256" >> $GITHUB_ENV

      - name: Upload artifact to release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: artifacts/${{ env.ZIP_NAME }}
          asset_name: ${{ env.ZIP_NAME }}
          asset_content_type: application/zip

      - name: Upload checksum to release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: artifacts/${{ env.ZIP_CHECKSUM }}
          asset_name: ${{ env.ZIP_CHECKSUM }}
          asset_content_type: text/plain

      - name: Upload build artifact (fallback)
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.platform }}
          path: |
            artifacts/${{ env.ZIP_NAME }}
            artifacts/${{ env.ZIP_CHECKSUM }}
