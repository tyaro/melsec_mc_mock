name: Build and attach macOS artifacts

on:
  workflow_dispatch:
    inputs:
      arch:
        description: 'Target arch: x86_64, aarch64, or all'
        required: true
        default: 'all'
  release:
    types: [published]

jobs:
  build-macos:
    name: Build macOS examples and upload
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Prepare targets
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ARCH="${{ github.event.inputs.arch }}"
          else
            ARCH="all"
          fi
          echo "ARCH=$ARCH" >> $GITHUB_ENV
          if [[ "$ARCH" == "x86_64" || "$ARCH" == "all" ]]; then
            rustup target add x86_64-apple-darwin || true
          fi
          if [[ "$ARCH" == "aarch64" || "$ARCH" == "all" ]]; then
            rustup target add aarch64-apple-darwin || true
          fi

      - name: Build examples
        shell: bash
        run: |
          set -euo pipefail
          if [[ "$ARCH" == "x86_64" || "$ARCH" == "all" ]]; then
            cargo build --release --examples --target x86_64-apple-darwin || true
          fi
          if [[ "$ARCH" == "aarch64" || "$ARCH" == "all" ]]; then
            cargo build --release --examples --target aarch64-apple-darwin || true
          fi

      - name: Package artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          REFNAME=${GITHUB_REF##*/}
          if [ -z "$REFNAME" ]; then
            REFNAME=${GITHUB_SHA:0:7}
          fi
          cd "$GITHUB_WORKSPACE"
          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          ZIP_X86=""
          ZIP_AARCH=""

          # Prepare and create per-arch zips if built
          if [[ "$ARCH" == "x86_64" || "$ARCH" == "all" ]]; then
            if [ -d target/x86_64-apple-darwin/release/examples ]; then
              ZIP_X86="melsec_com-${REFNAME}-macos-x86_64.zip"
              (cd target/x86_64-apple-darwin/release/examples && zip -r "$GITHUB_WORKSPACE/artifacts/${ZIP_X86}" . -x "*.d" "*.pdb")
              if command -v sha256sum >/dev/null 2>&1; then
                sha256sum "$GITHUB_WORKSPACE/artifacts/${ZIP_X86}" > "$GITHUB_WORKSPACE/artifacts/${ZIP_X86}.sha256"
              else
                shasum -a 256 "$GITHUB_WORKSPACE/artifacts/${ZIP_X86}" > "$GITHUB_WORKSPACE/artifacts/${ZIP_X86}.sha256"
              fi
              echo "ZIP_X86=${ZIP_X86}" >> $GITHUB_ENV
              echo "ZIP_X86_CHECKSUM=${ZIP_X86}.sha256" >> $GITHUB_ENV
            fi
          fi

          if [[ "$ARCH" == "aarch64" || "$ARCH" == "all" ]]; then
            if [ -d target/aarch64-apple-darwin/release/examples ]; then
              ZIP_AARCH="melsec_com-${REFNAME}-macos-aarch64.zip"
              (cd target/aarch64-apple-darwin/release/examples && zip -r "$GITHUB_WORKSPACE/artifacts/${ZIP_AARCH}" . -x "*.d" "*.pdb")
              if command -v sha256sum >/dev/null 2>&1; then
                sha256sum "$GITHUB_WORKSPACE/artifacts/${ZIP_AARCH}" > "$GITHUB_WORKSPACE/artifacts/${ZIP_AARCH}.sha256"
              else
                shasum -a 256 "$GITHUB_WORKSPACE/artifacts/${ZIP_AARCH}" > "$GITHUB_WORKSPACE/artifacts/${ZIP_AARCH}.sha256"
              fi
              echo "ZIP_AARCH=${ZIP_AARCH}" >> $GITHUB_ENV
              echo "ZIP_AARCH_CHECKSUM=${ZIP_AARCH}.sha256" >> $GITHUB_ENV
            fi
          fi

          # If nothing was packaged, fail loudly
          if [ -z "${ZIP_X86}${ZIP_AARCH}" ]; then
            echo "ERROR: No built macOS examples found for requested arch(es): $ARCH" >&2
            ls -la target || true
            exit 1
          fi

      - name: Upload x86_64 artifact to release
        if: github.event_name == 'release' && env.ZIP_X86 != ''
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: artifacts/${{ env.ZIP_X86 }}
          asset_name: ${{ env.ZIP_X86 }}
          asset_content_type: application/zip

      - name: Upload x86_64 checksum to release
        if: github.event_name == 'release' && env.ZIP_X86_CHECKSUM != ''
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: artifacts/${{ env.ZIP_X86_CHECKSUM }}
          asset_name: ${{ env.ZIP_X86_CHECKSUM }}
          asset_content_type: text/plain

      - name: Upload aarch64 artifact to release
        if: github.event_name == 'release' && env.ZIP_AARCH != ''
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: artifacts/${{ env.ZIP_AARCH }}
          asset_name: ${{ env.ZIP_AARCH }}
          asset_content_type: application/zip

      - name: Upload aarch64 checksum to release
        if: github.event_name == 'release' && env.ZIP_AARCH_CHECKSUM != ''
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: artifacts/${{ env.ZIP_AARCH_CHECKSUM }}
          asset_name: ${{ env.ZIP_AARCH_CHECKSUM }}
          asset_content_type: text/plain

      - name: Upload build artifact (fallback)
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-macos
          path: |
            artifacts/*.zip
            artifacts/*.sha256
